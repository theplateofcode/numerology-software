{% extends "base.html" %}
{% block title %}Documentation & Database{% endblock %}
{% block content %}

<div class="docs-container">
  
  <aside class="docs-index">
    <h3>Index</h3>
    <ul class="index-list">
      {% for section, records in data.items() %}
      <li class="index-section">
        <div class="section-toggle">
          <span>{{ section.replace('_', ' ').title() }}</span>
          <span class="chevron">›</span>
        </div>
        <ul class="nested-index">
          {% if records %}
            {% for row in records %}
            <li>
              <a href="#" 
                 class="record-link"
                 data-table="{{ section }}" 
                 data-id="{{ row.id }}"
                 data-name="{{ row.number or row.name or row.id }}">
                 {% if section == 'life_path' %}
                   Number {{ row.number }}
                 {% else %}
                   {{ row.name or row.id }}
                 {% endif %}
              </a>
            </li>
            {% endfor %}
          {% else %}
            <li><span class="no-records">No records</span></li>
          {% endif %}
        </ul>
      </li>
      {% endfor %}
    </ul>
  </aside>

  <main class="docs-content">
    <div id="form-container">
      <div class="placeholder">
        <h1>Database Reference</h1>
        <p>Select an item from the index to view or edit its details.</p>
      </div>
    </div>
  </main>

</div>

<style>
:root {
  --form-label-width: 180px;
  --form-gap: 1.5rem;
}

.docs-container {
  display: grid;
  grid-template-columns: 280px 1fr;
  gap: 1.5rem;
  align-items: flex-start;
}

/* --- INDEX / SIDEBAR --- */
.docs-index {
  background: var(--color-surface);
  padding: 1rem;
  border-radius: var(--radius);
  border: 1px solid var(--color-border);
  height: 90vh; /* Full-ish height */
  overflow-y: auto;
  position: sticky;
  top: 1rem; /* Sticks to top on scroll */
}
.docs-index h3 {
  margin-top: 0;
}
.index-list {
  list-style: none;
  padding: 0;
  margin: 0;
}
.section-toggle {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.5rem;
  font-weight: 600;
  font-size: 1.05rem;
  color: var(--color-accent);
  cursor: pointer;
  border-radius: var(--radius);
}
.section-toggle:hover {
  background: var(--color-accent-light);
}
.section-toggle .chevron {
  font-size: 1.25rem;
  transition: transform 0.2s ease;
}
.index-section.open > .section-toggle .chevron {
  transform: rotate(90deg);
}

.nested-index {
  list-style: none;
  padding-left: 0.5rem;
  display: none; /* Hidden by default */
  margin-top: 0.25rem;
}
.index-section.open > .nested-index {
  display: block; /* Show when open */
}

.nested-index li {
  margin: 1px 0;
}
.nested-index a {
  display: block;
  padding: 0.4rem 0.8rem;
  text-decoration: none;
  color: var(--color-text-secondary);
  border-radius: var(--radius);
  font-weight: 500;
}
.nested-index a:hover {
  background: #f0f0f0;
  color: var(--color-text);
}
.nested-index a.active {
  background: var(--color-accent);
  color: white;
}
.no-records {
  padding: 0.4rem 0.8rem;
  color: #999;
  font-style: italic;
}

/* --- MAIN CONTENT & FORM --- */
.docs-content {
  background: var(--color-surface);
  padding: 1.5rem 2rem;
  border-radius: var(--radius);
  border: 1px solid var(--color-border);
  min-height: 90vh;
}

.placeholder {
  text-align: center;
  padding-top: 10vh;
  color: #888;
}

/* Vertical Edit Form */
#editForm {
  animation: fadeIn 0.3s ease;
}
#editForm h3 {
  color: var(--color-accent);
  margin-top: 0;
  border-bottom: 2px solid var(--color-border);
  padding-bottom: 0.5rem;
}
.form-grid {
  display: grid;
  grid-template-columns: var(--form-label-width) 1fr;
  gap: var(--form-gap);
  max-height: 75vh;
  overflow-y: auto;
  padding: 0.5rem;
}

.form-row {
  /* This item will span 2 columns */
  grid-column: 1 / -1; 
  display: contents; /* Makes children act as grid items */
}

.form-row label {
  font-weight: 600;
  padding-top: 0.5rem;
  color: var(--color-text);
  word-break: break-word;
}

.form-row textarea {
  width: 100%;
  border: 1px solid var(--color-border);
  border-radius: var(--radius);
  padding: 0.6rem;
  resize: vertical;
  min-height: 50px;
  font-family: inherit;
  font-size: 0.95rem;
  transition: border-color 0.2s, box-shadow 0.2s;
}
.form-row textarea:focus {
  outline: none;
  border-color: var(--color-accent);
  box-shadow: 0 0 0 3px rgba(161,140,209,0.2);
}

.form-actions {
  grid-column: 1 / -1;
  text-align: right;
  border-top: 1px solid var(--color-border);
  padding-top: 1.5rem;
  margin-top: 1rem;
}

.save-button {
  background-color: var(--color-accent);
  color: white;
  border: none;
  border-radius: var(--radius);
  padding: 0.6rem 1.2rem;
  cursor: pointer;
  font-weight: 600;
  font-size: 0.95rem;
  transition: background 0.2s ease;
}
.save-button:hover {
  background-color: var(--color-hover);
}
.save-button.is-saving {
  background-color: #aaa;
  cursor: wait;
}
.save-button.is-saved {
  background-color: #28a745; /* Green */
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}
</style>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const formContainer = document.getElementById("form-container");
  const placeholder = document.querySelector(".placeholder").outerHTML;
  let activeLink = null;

  // 1. Sidebar Toggle Logic
  document.querySelectorAll(".section-toggle").forEach(toggle => {
    toggle.addEventListener("click", () => {
      toggle.parentElement.classList.toggle("open");
    });
  });

  // 2. Record Link Click Logic
  document.querySelectorAll(".record-link").forEach(link => {
    link.addEventListener("click", async (e) => {
      e.preventDefault();

      // Set active link style
      if (activeLink) {
        activeLink.classList.remove("active");
      }
      activeLink = link;
      activeLink.classList.add("active");

      const table = link.dataset.table;
      const id = link.dataset.id;
      const name = link.dataset.name;

      // Show loading state (optional)
      formContainer.innerHTML = "<p>Loading...</p>";

      try {
        // Fetch data from your API
        const res = await fetch(`/docs/get/${table}/${id}`);
        if (!res.ok) {
          throw new Error(`Error fetching data: ${res.statusText}`);
        }
        const data = await res.json();
        
        // Build the vertical form
        buildEditForm(table, id, name, data);

      } catch (error) {
        console.error("Failed to load record:", error);
        formContainer.innerHTML = `<p style="color: red;">Failed to load record. Check console.</p>`;
      }
    });
  });

  // 3. Function to build the form in the main content area
  function buildEditForm(table, id, name, data) {
    let formFieldsHTML = "";
    
    for (const [key, value] of Object.entries(data)) {
      // Skip ID, it's in the action URL
      if (key === "id") continue; 
      
      const label = key.replace(/_/g, ' ').toUpperCase();
      // Use (value ?? "") to handle null values gracefully
      const displayValue = (value === null || value === undefined) ? "" : value;
      
      // Use more rows for text/personality fields
      const rows = (key.includes('personality') || key.includes('thinking')) ? 5 : 3;

      formFieldsHTML += `
        <div class="form-row">
          <label for="field-${key}">${label}</label>
          <textarea id="field-${key}" name="${key}" rows="${rows}">${displayValue}</textarea>
        </div>
      `;
    }
    
    // ----------- THIS IS THE FIXED LINE -----------
    const sectionTitle = table.replace(/_/g, ' ').split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
    // ----------------------------------------------
    
    const itemTitle = (table === 'life_path') ? `Number ${name}` : name;
    
    formContainer.innerHTML = `
      <form id="editForm" data-table="${table}" data-id="${id}">
        <h3>Edit ${sectionTitle}: ${itemTitle}</h3>
        <div class="form-grid">
          ${formFieldsHTML}
          <div class="form-actions">
            <button type="submit" class="save-button">Save Changes</button>
          </div>
        </div>
      </form>
    `;

    // 4. Add submit handler to the new form
    document.getElementById("editForm").addEventListener("submit", handleFormSubmit);
  }

  // 4. AJAX Form Submit Logic
  async function handleFormSubmit(e) {
    e.preventDefault();
    const form = e.target;
    const table = form.dataset.table;
    const id = form.dataset.id;
    const saveButton = form.querySelector(".save-button");

    const formData = new FormData(form);
    const actionURL = `/docs/edit/${table}/${id}`;

    // Disable button and show saving state
    saveButton.disabled = true;
    saveButton.textContent = "Saving...";
    saveButton.classList.add("is-saving");

    try {
      const res = await fetch(actionURL, {
        method: "POST",
        body: formData
      });

      if (!res.ok) {
        throw new Error(`Save failed: ${res.statusText}`);
      }
      
      // Success! Show saved state
      saveButton.classList.remove("is-saving");
      saveButton.classList.add("is-saved");
      saveButton.textContent = "Saved! ✔️";

      // Reset button after 2 seconds
      setTimeout(() => {
        saveButton.disabled = false;
        saveButton.textContent = "Save Changes";
        saveButton.classList.remove("is-saved");
      }, 2000);

    } catch (error) {
      console.error("Failed to save:", error);
      saveButton.disabled = false;
      saveButton.textContent = "Save Failed! ❌";
      saveButton.classList.remove("is-saving");
      // Optionally reset after a delay
      setTimeout(() => {
        saveButton.textContent = "Save Changes";
      }, 3000);
    }
  }

});
</script>

{% endblock %}